# Default values for InferaDB Engine Helm chart

# Image configuration
image:
  repository: inferadb-engine
  pullPolicy: IfNotPresent
  tag: "" # Overrides the image tag (default is Chart appVersion)

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Replica configuration
replicaCount: 3

# Service account
serviceAccount:
  create: true
  annotations: {}
  name: ""
  automount: false

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  runAsGroup: 65532
  fsGroup: 65532
  seccompProfile:
    type: RuntimeDefault

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65532

# Service configuration
service:
  type: ClusterIP
  port: 8080
  grpcPort: 8081
  internalPort: 8082 # Internal/private REST API for server-to-server communication
  annotations: {}
  sessionAffinity: None
  # nodePort: 30080  # Only used when service.type is NodePort
  # grpcNodePort: 30081
  # internalNodePort: 30082
  # loadBalancerIP: ""  # Only used when service.type is LoadBalancer
  headless:
    enabled: false # Enable for StatefulSet deployments

# Ingress configuration
ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: inferadb.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: inferadb-tls
  #    hosts:
  #      - inferadb.local

# Resource limits
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# Horizontal Pod Autoscaling
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  customMetrics: []
    # - type: Pods
    #   pods:
    #     metric:
    #       name: inferadb_requests_per_second
    #     target:
    #       type: AverageValue
    #       averageValue: "1000"

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - inferadb-engine
          topologyKey: kubernetes.io/hostname

# Topology spread constraints
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: inferadb-engine

# InferaDB configuration
config:
  # Worker threads for async runtime (default: number of CPU cores)
  threads: 4
  # Log level: trace, debug, info, warn, error
  logging: "info"

  # Storage backend configuration
  storage:
    backend: "memory" # "memory" or "foundationdb"
    fdbClusterFile: "/etc/foundationdb/fdb.cluster" # Required if backend=foundationdb

  # Cache configuration
  cache:
    enabled: true
    maxCapacity: 10000 # Max cache entries
    ttl: 300 # TTL in seconds

  # JWT validation configuration
  jwt:
    jwksCacheTtl: 300 # JWKS cache TTL in seconds
    clockSkewSeconds: 60 # JWT clock tolerance
    maxTokenAgeSeconds: 86400 # Maximum token age (24 hours)
    requireJti: false # Require JTI claim in tokens

  # Replay protection configuration (requires Redis if enabled)
  replayProtection:
    enabled: false
    # redisUrl: "redis://redis-master:6379"

  # Control service configuration
  control:
    serviceUrl: "" # Set automatically via discovery, or set to static URL
    apiTimeoutMs: 5000 # Timeout for control API calls
    cacheTtl: 300 # Org/vault cache TTL in seconds
    certCacheTtl: 900 # Client cert cache TTL in seconds

  # Optional: provide full config file as YAML string
  configFile: ""

# Service discovery configuration
discovery:
  # Discovery mode: "static", "kubernetes_service", "tailscale"
  mode: "kubernetes_service"

  # Control discovery
  control:
    # Kubernetes service name (when mode = kubernetes_service)
    serviceName: "inferadb-control"
    namespace: "inferadb"
    port: 9092 # Control internal/private API port

    # Static URL (when mode = static)
    staticUrl: "http://localhost:9092"

    # Refresh interval for discovery (seconds)
    refreshInterval: 30

  # Tailscale multi-region configuration (when mode = tailscale)
  tailscale:
    # Enable Tailscale sidecar
    enabled: false

    # Local cluster name (e.g., "us-west-1")
    localCluster: "primary"

    # Remote clusters to discover via Tailscale mesh
    # remoteClusters:
    # - name: "eu-west-1"
    #   tailscaleDomain: "eu-west-1.ts.net"
    #   serviceName: "inferadb-control"
    #   port: 9092
    # - name: "ap-southeast-1"
    #   tailscaleDomain: "ap-southeast-1.ts.net"
    #   serviceName: "inferadb-control"
    #   port: 9092
    remoteClusters: []

    # Tailscale auth key (reference to secret)
    authKey:
      # Use existing secret
      existingSecret: "tailscale-auth"
      key: "authkey"
      # Or provide directly (not recommended for production)
      value: ""

    # Tailscale sidecar image
    image:
      repository: tailscale/tailscale
      tag: "v1.56.1"
      pullPolicy: IfNotPresent

    # Resource limits for Tailscale sidecar
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

    # Additional Tailscale arguments
    extraArgs: "--accept-routes"

    # Accept DNS from Tailscale
    acceptDNS: false

    # Advertise routes
    advertiseRoutes: ""

# Secrets (use external secret manager in production)
secrets:
  # JWKS URL for JWT validation
  jwksUrl: "https://auth.example.com/.well-known/jwks.json"

  # Redis URL for replay protection
  redisUrl: "redis://redis-master:6379"
  redisPassword: ""

  # OAuth client secret
  oidcClientSecret: ""

  # FoundationDB cluster file content
  fdbClusterFile: ""

  # Additional custom secrets
  additional: {}

# External Secrets Operator integration
externalSecrets:
  enabled: false
  secretStoreRef:
    name: ""
    kind: SecretStore # or ClusterSecretStore
  refreshInterval: 1h
  data: []
    # - secretKey: INFERADB__AUTH__JWKS_URL
    #   remoteRef:
    #     key: inferadb/prod/auth
    #     property: jwks_url

# Health check configuration
healthCheck:
  liveness:
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3

  readiness:
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 3

  startup:
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 30

# Graceful shutdown
terminationGracePeriodSeconds: 30

# Init containers (e.g., wait for FoundationDB)
initContainers: []
  # - name: wait-for-fdb
  #   image: busybox:1.36
  #   command:
  #   - sh
  #   - -c
  #   - |
  #     until nc -z -v -w30 foundationdb-cluster 4500; do
  #       sleep 5
  #     done

# Extra environment variables
extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "custom-value"

# Extra volume mounts
extraVolumeMounts: []
  # - name: extra-config
  #   mountPath: /extra
  #   readOnly: true

# Extra volumes
extraVolumes: []
  # - name: extra-config
  #   configMap:
  #     name: extra-config

# ServiceMonitor for Prometheus Operator
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  honorLabels: true
  relabelings: []
  metricRelabelings: []

# External dependencies
foundationdb:
  enabled: false
  clusterName: "inferadb-fdb"
  version: "7.1.38"

redis:
  enabled: false
  architecture: standalone
  auth:
    enabled: true
    password: "change-me"
