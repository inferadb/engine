apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "inferadb-engine.fullname" . }}-config
  labels:
    {{- include "inferadb-engine.labels" . | nindent 4 }}
data:
  # Root-level configuration
  INFERADB__ENGINE__THREADS: "{{ .Values.config.threads }}"
  INFERADB__ENGINE__LOGGING: "{{ .Values.config.logging }}"

  # Listen configuration (combined host:port addresses)
  INFERADB__ENGINE__LISTEN__HTTP: "0.0.0.0:{{ .Values.service.port }}"
  INFERADB__ENGINE__LISTEN__GRPC: "0.0.0.0:{{ .Values.service.grpcPort }}"
  INFERADB__ENGINE__LISTEN__MESH: "0.0.0.0:{{ .Values.service.internalPort }}"

  # Storage configuration
  INFERADB__ENGINE__STORAGE__BACKEND: "{{ .Values.config.storage.backend }}"
  {{- if eq .Values.config.storage.backend "foundationdb" }}
  INFERADB__ENGINE__STORAGE__FDB_CLUSTER_FILE: "{{ .Values.config.storage.fdbClusterFile }}"
  {{- end }}

  # Cache configuration
  INFERADB__ENGINE__CACHE__ENABLED: "{{ .Values.config.cache.enabled }}"
  {{- if .Values.config.cache.enabled }}
  INFERADB__ENGINE__CACHE__MAX_CAPACITY: "{{ .Values.config.cache.maxCapacity }}"
  INFERADB__ENGINE__CACHE__TTL: "{{ .Values.config.cache.ttl }}"
  {{- end }}

  # JWT validation configuration
  INFERADB__ENGINE__JWT__JWKS_CACHE_TTL: "{{ .Values.config.jwt.jwksCacheTtl }}"
  INFERADB__ENGINE__JWT__CLOCK_SKEW_SECONDS: "{{ .Values.config.jwt.clockSkewSeconds }}"
  INFERADB__ENGINE__JWT__MAX_TOKEN_AGE_SECONDS: "{{ .Values.config.jwt.maxTokenAgeSeconds }}"
  INFERADB__ENGINE__JWT__REQUIRE_JTI: "{{ .Values.config.jwt.requireJti }}"

  # Replay protection configuration
  INFERADB__ENGINE__REPLAY_PROTECTION__ENABLED: "{{ .Values.config.replayProtection.enabled }}"
  {{- if .Values.config.replayProtection.enabled }}
  {{- if .Values.config.replayProtection.redisUrl }}
  INFERADB__ENGINE__REPLAY_PROTECTION__REDIS_URL: "{{ .Values.config.replayProtection.redisUrl }}"
  {{- end }}
  {{- end }}

  # Control service configuration
  {{- if .Values.config.control.serviceUrl }}
  INFERADB__ENGINE__CONTROL__SERVICE_URL: "{{ .Values.config.control.serviceUrl }}"
  {{- end }}
  INFERADB__ENGINE__CONTROL__API_TIMEOUT_MS: "{{ .Values.config.control.apiTimeoutMs }}"
  INFERADB__ENGINE__CONTROL__CACHE_TTL: "{{ .Values.config.control.cacheTtl }}"
  INFERADB__ENGINE__CONTROL__CERT_CACHE_TTL: "{{ .Values.config.control.certCacheTtl }}"
  {{- if .Values.config.configFile }}
  config.yaml: |
    {{- .Values.config.configFile | nindent 4 }}
  {{- end }}
