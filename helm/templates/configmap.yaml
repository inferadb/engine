apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "inferadb-engine.fullname" . }}-config
  labels:
    {{- include "inferadb-engine.labels" . | nindent 4 }}
data:
  # Root-level configuration
  INFERADB__ENGINE__THREADS: "{{ .Values.config.threads }}"
  INFERADB__ENGINE__LOGGING: "{{ .Values.config.logging }}"

  # Listen configuration (combined host:port addresses)
  INFERADB__ENGINE__LISTEN__HTTP: "0.0.0.0:{{ .Values.service.port }}"
  INFERADB__ENGINE__LISTEN__GRPC: "0.0.0.0:{{ .Values.service.grpcPort }}"
  INFERADB__ENGINE__LISTEN__MESH: "0.0.0.0:{{ .Values.service.meshPort }}"

  # Storage configuration
  INFERADB__ENGINE__STORAGE: "{{ .Values.config.storage }}"
  {{- if eq .Values.config.storage "ledger" }}
  INFERADB__ENGINE__LEDGER__ENDPOINT: "{{ .Values.config.ledger.endpoint }}"
  {{- if .Values.config.ledger.clientId }}
  INFERADB__ENGINE__LEDGER__CLIENT_ID: "{{ .Values.config.ledger.clientId }}"
  {{- end }}
  {{- if .Values.config.ledger.namespaceId }}
  INFERADB__ENGINE__LEDGER__NAMESPACE_ID: "{{ .Values.config.ledger.namespaceId }}"
  {{- end }}
  {{- end }}

  # Cache configuration
  INFERADB__ENGINE__CACHE__ENABLED: "{{ .Values.config.cache.enabled }}"
  {{- if .Values.config.cache.enabled }}
  INFERADB__ENGINE__CACHE__CAPACITY: "{{ .Values.config.cache.capacity }}"
  INFERADB__ENGINE__CACHE__TTL: "{{ .Values.config.cache.ttl }}"
  {{- end }}

  # Token validation configuration
  INFERADB__ENGINE__TOKEN__CACHE_TTL: "{{ .Values.config.token.cacheTtl }}"
  INFERADB__ENGINE__TOKEN__CLOCK_SKEW: "{{ .Values.config.token.clockSkew }}"
  INFERADB__ENGINE__TOKEN__MAX_AGE: "{{ .Values.config.token.maxAge }}"

  # Mesh configuration (communication with Control service)
  {{- if .Values.config.mesh.url }}
  INFERADB__ENGINE__MESH__URL: "{{ .Values.config.mesh.url }}"
  {{- else if eq .Values.discovery.mode "kubernetes" }}
  INFERADB__ENGINE__MESH__URL: "http://{{ .Values.discovery.control.serviceName }}.{{ .Values.discovery.control.namespace }}:{{ .Values.discovery.control.port }}"
  {{- else if eq .Values.discovery.mode "none" }}
  INFERADB__ENGINE__MESH__URL: "{{ .Values.discovery.control.staticUrl }}"
  {{- end }}
  INFERADB__ENGINE__MESH__TIMEOUT: "{{ .Values.config.mesh.timeout }}"
  INFERADB__ENGINE__MESH__CACHE_TTL: "{{ .Values.config.mesh.cacheTtl }}"
  INFERADB__ENGINE__MESH__CERT_CACHE_TTL: "{{ .Values.config.mesh.certCacheTtl }}"

  # Discovery configuration
  {{- if eq .Values.discovery.mode "kubernetes" }}
  INFERADB__ENGINE__DISCOVERY__MODE: '{"type": "kubernetes"}'
  {{- else if eq .Values.discovery.mode "tailscale" }}
  INFERADB__ENGINE__DISCOVERY__MODE: '{"type": "tailscale", "local_cluster": "{{ .Values.discovery.tailscale.localCluster }}"}'
  {{- else }}
  INFERADB__ENGINE__DISCOVERY__MODE: '{"type": "none"}'
  {{- end }}
  INFERADB__ENGINE__DISCOVERY__CACHE_TTL: "{{ .Values.discovery.cacheTtl }}"
  INFERADB__ENGINE__DISCOVERY__HEALTH_CHECK_INTERVAL: "{{ .Values.discovery.healthCheckInterval }}"

  {{- if .Values.config.configFile }}
  config.yaml: |
    {{- .Values.config.configFile | nindent 4 }}
  {{- end }}
