apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "inferadb-engine.fullname" . }}-config
  labels:
    {{- include "inferadb-engine.labels" . | nindent 4 }}
data:
  # Server configuration (combined host:port addresses)
  INFERADB__SERVER__PUBLIC_REST: "0.0.0.0:{{ .Values.service.port }}"
  INFERADB__SERVER__PUBLIC_GRPC: "0.0.0.0:{{ .Values.service.grpcPort }}"
  INFERADB__SERVER__PRIVATE_REST: "0.0.0.0:{{ .Values.service.internalPort }}"
  INFERADB__SERVER__WORKER_THREADS: "{{ .Values.config.server.workerThreads }}"

  # Storage configuration
  INFERADB__STORAGE__BACKEND: "{{ .Values.config.storage.backend }}"
  {{- if eq .Values.config.storage.backend "foundationdb" }}
  INFERADB__STORAGE__FDB_CLUSTER_FILE: "{{ .Values.config.storage.fdbClusterFile }}"
  {{- end }}

  # Cache configuration
  INFERADB__CACHE__ENABLED: "{{ .Values.config.cache.enabled }}"
  {{- if .Values.config.cache.enabled }}
  INFERADB__CACHE__MAX_CAPACITY: "{{ .Values.config.cache.maxCapacity }}"
  INFERADB__CACHE__TTL: "{{ .Values.config.cache.ttl }}"
  {{- end }}

  # Authentication configuration
  {{- if .Values.config.auth.enabled }}
  INFERADB__AUTH__JWKS_CACHE_TTL: "{{ .Values.config.auth.jwksCacheTtl }}"
  INFERADB__AUTH__REPLAY_PROTECTION: "{{ .Values.config.auth.replayProtection }}"
  INFERADB__AUTH__CLOCK_SKEW_SECONDS: "{{ .Values.config.auth.clockSkewSeconds }}"
  INFERADB__AUTH__MAX_TOKEN_AGE_SECONDS: "{{ .Values.config.auth.maxTokenAgeSeconds }}"
  INFERADB__AUTH__REQUIRE_JTI: "{{ .Values.config.auth.requireJti }}"
  INFERADB__AUTH__MANAGEMENT_CACHE_TTL: "{{ .Values.config.auth.managementCacheTtl }}"
  INFERADB__AUTH__CERT_CACHE_TTL: "{{ .Values.config.auth.certCacheTtl }}"
  INFERADB__AUTH__MANAGEMENT_VERIFY_VAULT_OWNERSHIP: "{{ .Values.config.auth.managementVerifyVaultOwnership }}"
  INFERADB__AUTH__MANAGEMENT_VERIFY_ORG_STATUS: "{{ .Values.config.auth.managementVerifyOrgStatus }}"
  {{- end }}

  # Observability configuration
  INFERADB__OBSERVABILITY__LOG_LEVEL: "{{ .Values.config.observability.logLevel }}"
  INFERADB__OBSERVABILITY__METRICS_ENABLED: "{{ .Values.config.observability.metricsEnabled }}"
  INFERADB__OBSERVABILITY__TRACING_ENABLED: "{{ .Values.config.observability.tracingEnabled }}"

  {{- if .Values.config.configFile }}
  config.yaml: |
    {{- .Values.config.configFile | nindent 4 }}
  {{- end }}
