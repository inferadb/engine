openapi: 3.1.0
info:
  title: InferaDB API
  version: 0.1.0
  description: |
    InferaDB is a high-performance authorization engine implementing Relationship-Based Access Control (ReBAC) in Rust.

    ## Authentication

    InferaDB uses JWT (JSON Web Token) authentication. Include your JWT in the `Authorization` header:

    ```
    Authorization: Bearer <your-jwt-token>
    ```

    Supported authentication methods:
    - **Private-Key JWT (RFC 7523)** - For tenant SDKs and CLIs
    - **OAuth 2.0 Bearer Tokens (RFC 6749)** - For dashboards and enterprise authentication
    - **OpenID Connect (OIDC)** - Automatic JWKS discovery

    See [Authentication Guide](../docs/security/authentication.md) for details on creating JWTs.

    ## Rate Limiting

    Rate limiting is configured per deployment. Default limits:
    - 1000 requests per minute per IP
    - 10000 requests per minute per tenant

    Rate limit headers are included in responses:
    ```
    X-RateLimit-Limit: 1000
    X-RateLimit-Remaining: 999
    X-RateLimit-Reset: 1730905200
    ```

    ## Consistency Guarantees

    - **Read-Your-Writes**: After a write, subsequent reads from the same client will see that write
    - **Snapshot Isolation**: All operations within a request see a consistent snapshot
    - **Eventual Consistency**: Multi-region deployments may have slight replication lag

  contact:
    name: InferaDB Support
    url: https://github.com/inferadb/server/issues
  license:
    name: Business Source License 1.1
    url: https://github.com/inferadb/server/blob/main/LICENSE

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.inferadb.com/v1
    description: Production API

tags:
  - name: health
    description: Health and status endpoints
  - name: authorization
    description: Authorization check and expansion endpoints
  - name: relationships
    description: Relationship management (write/delete/list)

paths:
  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Check if the service is running and healthy
      operationId: healthCheck
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              examples:
                healthy:
                  value:
                    status: healthy
                    version: 0.1.0
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /check:
    post:
      tags:
        - authorization
      summary: Check permission
      description: |
        Check if a subject has a specific permission on a resource.

        This is the primary authorization endpoint. It returns a simple allow/deny decision.

        **Performance**: Typical latency is <5ms for simple checks, <20ms for complex nested relations.
      operationId: checkPermission
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CheckRequest"
            examples:
              simple_check:
                summary: Simple permission check
                value:
                  subject: user:alice
                  resource: document:readme
                  permission: can_view
              with_context:
                summary: Check with context for WASM modules
                value:
                  subject: user:alice
                  resource: document:readme
                  permission: can_view
                  context:
                    ip_address: 192.168.1.1
                    time: "2024-01-15T10:30:00Z"
      responses:
        "200":
          description: Check completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckResponse"
              examples:
                allow:
                  value:
                    decision: allow
                deny:
                  value:
                    decision: deny
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /check/trace:
    post:
      tags:
        - authorization
      summary: Check permission with trace
      description: |
        Check permission and return detailed evaluation trace for debugging.

        The trace shows the complete evaluation tree, including which relations were checked,
        which rules fired, and why the final decision was made.

        **Note**: This endpoint should only be used for debugging. Use `/check` for production.
      operationId: checkPermissionWithTrace
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CheckRequest"
      responses:
        "200":
          description: Check completed with trace
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckTraceResponse"
              examples:
                traced_check:
                  value:
                    decision: allow
                    trace:
                      decision: allow
                      node_type: union
                      children:
                        - decision: allow
                          node_type: direct
                          relation: viewer
                          children: []
                        - decision: deny
                          node_type: computed_userset
                          relation: editor
                          children: []
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /expand:
    post:
      tags:
        - authorization
      summary: Expand relation
      description: |
        Expand a relation into a tree showing all users and how they have access.

        This is useful for understanding who has access to a resource and why.
        The returned tree shows the complete authorization graph.
      operationId: expandRelation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExpandRequest"
            examples:
              expand_viewers:
                summary: Expand viewers of a document
                value:
                  resource: document:readme
                  relation: can_view
      responses:
        "200":
          description: Expansion completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExpandResponse"
              examples:
                expansion:
                  value:
                    tree:
                      node_type: union
                      children:
                        - node_type: this
                          children: []
                        - node_type: computed_userset
                          relation: editor
                          children:
                            - node_type: this
                              children: []
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Resource or relation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /list-resources:
    post:
      tags:
        - authorization
      summary: List accessible resources
      description: |
        Lookup all resources of a given type that a subject can access with a specific permission.

        This is the reverse of `/check` - instead of checking if a subject has access to one specific resource,
        this returns all resources the subject can access.

        **Use Cases**:
        - Listing files a user can view
        - Showing organizations a user is a member of
        - Finding all documents a user can edit

        **Performance**: Typical latency varies with resource count:
        - 1K resources: <10ms
        - 10K resources: <100ms
        - 100K resources: <1s (use pagination)

        **Pagination**: Use `limit` and `cursor` to paginate through large result sets.
      operationId: listResources
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ListResourcesRequest"
            examples:
              list_viewable_docs:
                summary: List all documents a user can view
                value:
                  subject: user:alice
                  resource_type: document
                  permission: can_view
              with_pagination:
                summary: Paginated lookup with limit
                value:
                  subject: user:alice
                  resource_type: document
                  permission: can_view
                  limit: 100
              continue_pagination:
                summary: Continue paginated lookup with cursor
                value:
                  subject: user:alice
                  resource_type: document
                  permission: can_view
                  limit: 100
                  cursor: eyJvZmZzZXQiOjEwMH0=
      responses:
        "200":
          description: Lookup completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListResourcesResponse"
              examples:
                found_resources:
                  value:
                    resources:
                      - document:readme
                      - document:guide
                      - document:tutorial
                    total_count: 3
                with_pagination:
                  value:
                    resources:
                      - document:1
                      - document:2
                    cursor: eyJvZmZzZXQiOjJ9
                    total_count: 2
                no_resources:
                  value:
                    resources: []
                    total_count: 0
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /list-resources/stream:
    post:
      tags:
        - authorization
      summary: List resources with Server-Sent Events streaming
      description: |
        List accessible resources and stream them as they're discovered using Server-Sent Events (SSE).

        This is useful for large result sets where you want to show results progressively
        instead of waiting for the entire response.

        **Events**:
        - `message` events: Individual resources as they're discovered
        - `summary` event: Final metadata (cursor, total_count, complete flag)

        **Example client code**:
        ```javascript
        const eventSource = new EventSource('/api/v1/list-resources/stream');
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log('Found resource:', data.resource);
        };
        eventSource.addEventListener('summary', (event) => {
          const summary = JSON.parse(event.data);
          console.log('Complete:', summary.complete);
          eventSource.close();
        });
        ```
      operationId: listResourcesStream
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ListResourcesRequest"
      responses:
        "200":
          description: SSE stream of resources
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Server-Sent Events stream with two event types:
                  1. `message` events containing individual resources
                  2. `summary` event with final metadata
              examples:
                stream_example:
                  value: |
                    data: {"resource":"document:readme","index":0}

                    data: {"resource":"document:guide","index":1}

                    event: summary
                    data: {"cursor":null,"total_count":2,"complete":true}
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /list-relationships:
    post:
      tags:
        - relationships
      summary: List relationships
      description: |
        List authorization relationships with optional filtering.

        This endpoint is useful for:
        - **Debugging**: Inspect what relationships exist in the system
        - **Administration**: Build UIs showing who has access to what
        - **Auditing**: Track authorization state over time
        - **Data Export**: Extract relationships for backup or analysis

        **Filtering**: All filter parameters are optional and can be combined:
        - `resource`: Filter by exact resource (e.g., "doc:readme")
        - `relation`: Filter by relation type (e.g., "viewer")
        - `subject`: Filter by exact subject (e.g., "user:alice")

        **Pagination**: Default limit is 100 relationships, maximum is 1000 per request.

        **Performance**: Queries use storage indexes for optimal performance.
        Typical latency is <10ms for filtered queries, <50ms for full scans.
      operationId: listRelationships
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ListRelationshipsRequest"
            examples:
              all_relationships:
                summary: List all relationships
                value:
                  limit: 100
              filter_by_resource:
                summary: Find who has access to a resource
                value:
                  resource: "doc:readme"
                  limit: 100
              filter_by_subject:
                summary: Find what a subject has access to
                value:
                  subject: "user:alice"
                  limit: 100
              filter_combined:
                summary: Specific relationship query
                value:
                  resource: "doc:readme"
                  relation: "viewer"
                  subject: "user:alice"
      responses:
        "200":
          description: List of matching relationships
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListRelationshipsResponse"
              examples:
                success:
                  value:
                    relationships:
                      - resource: "doc:readme"
                        relation: "viewer"
                        subject: "user:alice"
                      - resource: "doc:readme"
                        relation: "editor"
                        subject: "user:bob"
                    cursor: null
                    total_count: 2
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /list-relationships/stream:
    post:
      tags:
        - relationships
      summary: List relationships with Server-Sent Events streaming
      description: |
        List relationships and stream them as they're discovered using Server-Sent Events (SSE).

        Useful for large result sets (e.g., listing all relationships for auditing)
        where you want to show results progressively.

        **Events**:
        - `message` events: Individual relationships as they're discovered
        - `summary` event: Final metadata (cursor, total_count, complete flag)

        **Example client code**:
        ```javascript
        const eventSource = new EventSource('/api/v1/list-relationships/stream');
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log('Found relationship:', data.relationship);
        };
        eventSource.addEventListener('summary', (event) => {
          const summary = JSON.parse(event.data);
          console.log('Complete:', summary.complete);
          eventSource.close();
        });
        ```
      operationId: listRelationshipsStream
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ListRelationshipsRequest"
      responses:
        "200":
          description: SSE stream of relationships
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Server-Sent Events stream with two event types:
                  1. `message` events containing individual relationships
                  2. `summary` event with final metadata
              examples:
                stream_example:
                  value: |
                    data: {"relationship":{"resource":"doc:readme","relation":"viewer","subject":"user:alice"},"index":0}

                    data: {"relationship":{"resource":"doc:guide","relation":"editor","subject":"user:bob"},"index":1}

                    event: summary
                    data: {"cursor":null,"total_count":2,"complete":true}
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /write:
    post:
      tags:
        - relationships
      summary: Write relationships
      description: |
        Write one or more authorization relationships.

        Relationships define access control relationships between subjects and resources. For example:
        - `user:alice` is a `viewer` of `document:readme`
        - `group:engineers` is a `member` of `org:acme`

        **Best Practice**: Batch multiple relationships in a single request for better performance.
      operationId: writeRelationships
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WriteRequest"
            examples:
              single_relationship:
                summary: Write single relationship
                value:
                  relationships:
                    - resource: document:readme
                      relation: viewer
                      subject: user:alice
              batch_relationships:
                summary: Batch write multiple relationships
                value:
                  relationships:
                    - resource: document:readme
                      relation: viewer
                      subject: user:alice
                    - resource: document:readme
                      relation: editor
                      subject: user:bob
                    - resource: document:secret
                      relation: viewer
                      subject: group:engineers
      responses:
        "200":
          description: Relationships written successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WriteResponse"
              examples:
                written:
                  value:
                    revision: 42
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /delete:
    post:
      tags:
        - relationships
      summary: Delete relationships
      description: |
        Delete one or more authorization relationships.

        **Note**: This endpoint is not yet implemented. Use the write endpoint to manage relationships.
      operationId: deleteRelationships
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeleteRequest"
      responses:
        "200":
          description: Relationships deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "501":
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT authentication token.

        Include your JWT in the Authorization header:
        ```
        Authorization: Bearer <your-jwt-token>
        ```

        See [Authentication Guide](../docs/security/authentication.md) for details.

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - version
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Health status of the service
        version:
          type: string
          description: Version of the InferaDB server
          example: 0.1.0

    CheckRequest:
      type: object
      required:
        - subject
        - resource
        - permission
      properties:
        subject:
          type: string
          description: The user or entity requesting access
          example: user:alice
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
        resource:
          type: string
          description: The resource being accessed
          example: document:readme
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
        permission:
          type: string
          description: The permission being checked
          example: can_view
          pattern: "^[a-z_][a-z0-9_]*$"
        context:
          type: object
          description: Additional context for WASM modules (optional)
          additionalProperties: true
          example:
            ip_address: 192.168.1.1
            time: "2024-01-15T10:30:00Z"

    CheckResponse:
      type: object
      required:
        - decision
      properties:
        decision:
          type: string
          enum: [allow, deny]
          description: The authorization decision

    CheckTraceResponse:
      type: object
      required:
        - decision
        - trace
      properties:
        decision:
          type: string
          enum: [allow, deny]
          description: The authorization decision
        trace:
          $ref: "#/components/schemas/TraceNode"

    TraceNode:
      type: object
      required:
        - decision
        - node_type
        - children
      properties:
        decision:
          type: string
          enum: [allow, deny]
          description: Decision at this node
        node_type:
          type: string
          enum:
            - direct
            - computed_userset
            - union
            - intersection
            - exclusion
            - related_object_userset
          description: |
            Type of evaluation node:
            - `direct`: Direct relationship lookup
            - `computed_userset`: Computed relation
            - `union`: OR operation
            - `intersection`: AND operation
            - `exclusion`: EXCEPT operation
            - `related_object_userset`: Related object userset (follow relationship to compute permission on related objects)
        relation:
          type: string
          description: Relation being evaluated (if applicable)
        children:
          type: array
          items:
            $ref: "#/components/schemas/TraceNode"
          description: Sub-evaluations

    ExpandRequest:
      type: object
      required:
        - resource
        - relation
      properties:
        resource:
          type: string
          description: The resource to expand
          example: document:readme
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
        relation:
          type: string
          description: The relation to expand
          example: can_view
          pattern: "^[a-z_][a-z0-9_]*$"

    ExpandResponse:
      type: object
      required:
        - tree
      properties:
        tree:
          $ref: "#/components/schemas/ExpandNode"

    ExpandNode:
      type: object
      required:
        - node_type
        - children
      properties:
        node_type:
          type: string
          enum:
            - this
            - computed_userset
            - related_object_userset
            - union
            - intersection
            - exclusion
          description: |
            Type of expand node:
            - `this`: Direct relation
            - `computed_userset`: Computed relation
            - `related_object_userset`: Related object userset (follow relationship to compute permission on related objects)
            - `union`: OR operation
            - `intersection`: AND operation
            - `exclusion`: EXCEPT operation
        relation:
          type: string
          description: Relation name (for computed_userset)
        relationship:
          type: string
          description: Relationship name (for related_object_userset)
        computed:
          type: string
          description: Computed relation (for related_object_userset)
        children:
          type: array
          items:
            $ref: "#/components/schemas/ExpandNode"
          description: Child nodes

    ListResourcesRequest:
      type: object
      required:
        - subject
        - resource_type
        - permission
      properties:
        subject:
          type: string
          description: The user or entity requesting access
          example: user:alice
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
        resource_type:
          type: string
          description: |
            The type of resources to lookup (e.g., "document", "folder", "org").
            This matches the first part of the resource identifier before the colon.
          example: document
          pattern: "^[a-z_][a-z0-9_]*$"
        permission:
          type: string
          description: The permission to check for each resource
          example: can_view
          pattern: "^[a-z_][a-z0-9_]*$"
        limit:
          type: integer
          format: int32
          description: |
            Maximum number of resources to return. Use for pagination.
            If omitted, all matching resources are returned (not recommended for large datasets).
          example: 100
          minimum: 1
          maximum: 10000
        cursor:
          type: string
          description: |
            Continuation token from a previous response.
            Use to fetch the next page of results.
          example: eyJvZmZzZXQiOjEwMH0=
        resource_id_pattern:
          type: string
          description: |
            Optional glob pattern to filter resource IDs. Supports wildcards:
            - `*` matches any sequence of characters
            - `?` matches exactly one character

            Examples:
            - `doc:readme*` matches doc:readme, doc:readme123, doc:readme_final
            - `doc:file?` matches doc:file1, doc:fileA, but not doc:file12
            - `doc:project_*_report` matches doc:project_a_report, doc:project_xyz_report
          example: doc:readme*

    ListResourcesResponse:
      type: object
      required:
        - resources
      properties:
        resources:
          type: array
          items:
            type: string
            pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
          description: |
            List of resource identifiers the subject can access.
            Each resource is in the format "type:id" (e.g., "document:readme").
          example:
            - document:readme
            - document:guide
            - document:tutorial
        cursor:
          type: string
          description: |
            Continuation token for fetching the next page.
            Present only if there are more results available.
            Pass this value in the next request's `cursor` field.
          example: eyJvZmZzZXQiOjEwMH0=
          nullable: true
        total_count:
          type: integer
          format: int64
          description: |
            Total number of resources checked in this request.
            This may be less than the actual total if pagination is used.
            This is NOT the total number of accessible resources across all pages.
          example: 100
          nullable: true

    ListRelationshipsRequest:
      type: object
      properties:
        resource:
          type: string
          description: |
            Optional filter by exact resource.
            If provided, only relationships with this resource are returned.
          example: doc:readme
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
          nullable: true
        relation:
          type: string
          description: |
            Optional filter by relation type.
            If provided, only relationships with this relation are returned.
          example: viewer
          pattern: "^[a-z_][a-z0-9_]*$"
          nullable: true
        subject:
          type: string
          description: |
            Optional filter by exact subject.
            If provided, only relationships with this subject are returned.
          example: user:alice
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
          nullable: true
        limit:
          type: integer
          format: int32
          description: |
            Maximum number of relationships to return.
            Default: 100, Maximum: 1000
          example: 100
          minimum: 1
          maximum: 1000
          default: 100
        cursor:
          type: string
          description: |
            Continuation token from a previous response.
            Use to fetch the next page of results.
          example: eyJvZmZzZXQiOjEwMH0=
          nullable: true

    ListRelationshipsResponse:
      type: object
      required:
        - relationships
      properties:
        relationships:
          type: array
          items:
            $ref: "#/components/schemas/Relationship"
          description: |
            List of relationships matching the filter criteria.
            Each relationship represents an authorization relationship between
            a subject and a resource.
          example:
            - resource: doc:readme
              relation: viewer
              subject: user:alice
            - resource: doc:readme
              relation: editor
              subject: user:bob
        cursor:
          type: string
          description: |
            Continuation token for fetching the next page.
            Present only if there are more results available.
            Pass this value in the next request's `cursor` field.
          example: eyJvZmZzZXQiOjEwMH0=
          nullable: true
        total_count:
          type: integer
          format: int64
          description: |
            Total number of relationships returned in this response.
            This may be less than the actual total if pagination is used.
          example: 2
          nullable: true

    Relationship:
      type: object
      required:
        - resource
        - relation
        - subject
      properties:
        resource:
          type: string
          description: The resource being accessed
          example: document:readme
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"
        relation:
          type: string
          description: The relation type
          example: viewer
          pattern: "^[a-z_][a-z0-9_]*$"
        subject:
          type: string
          description: The subject (user or entity)
          example: user:alice
          pattern: "^[a-z_][a-z0-9_]*:[a-z0-9_-]+$"

    WriteRequest:
      type: object
      required:
        - relationships
      properties:
        relationships:
          type: array
          items:
            $ref: "#/components/schemas/Relationship"
          description: Array of relationships to write
          minItems: 1
          maxItems: 1000

    WriteResponse:
      type: object
      required:
        - revision
      properties:
        revision:
          type: integer
          format: int64
          description: New revision number after write
          example: 42

    DeleteRequest:
      type: object
      required:
        - relationships
      properties:
        relationships:
          type: array
          items:
            $ref: "#/components/schemas/Relationship"
          description: Array of relationships to delete
          minItems: 1
          maxItems: 1000

    DeleteResponse:
      type: object
      required:
        - revision
      properties:
        revision:
          type: integer
          format: int64
          description: New revision number after delete

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error type or category
          example: Invalid request
        message:
          type: string
          description: Detailed error message
          example: Missing required field 'subject'
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true

  responses:
    BadRequest:
      description: Invalid request format or parameters
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            missing_field:
              value:
                error: Invalid request
                message: Missing required field 'subject'
            invalid_format:
              value:
                error: Invalid request
                message: Subject must match pattern 'type:id'

    Unauthorized:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            missing_token:
              value:
                error: Unauthorized
                message: Missing Authorization header
            invalid_token:
              value:
                error: Unauthorized
                message: Invalid JWT signature

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per window
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in current window
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when the rate limit resets
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Rate limit exceeded
            message: Too many requests. Please retry after 60 seconds.

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Internal server error
            message: An unexpected error occurred

x-tagGroups:
  - name: Core
    tags:
      - health
      - authorization
  - name: Data Management
    tags:
      - relationships
