# Engine + Ledger Integration Test Environment
# This setup provides a single-node Ledger cluster for running Engine integration tests.
# NOT FOR PRODUCTION USE
#
# Usage:
#   docker-compose up -d ledger
#   docker-compose run --rm test-runner
#
# Or with the helper script:
#   ./run-tests.sh

services:
  # Single-node Ledger cluster for integration testing
  # Uses pre-built canary image from Docker Hub (built from inferadb/ledger repo)
  ledger:
    image: inferadb/inferadb-ledger:canary
    container_name: inferadb-engine-ledger-test
    hostname: ledger-server
    networks:
      - engine-ledger-test-network
    ports:
      - "50051:50051"
      - "9091:9090"
    command: ["--single"]
    environment:
      INFERADB__LEDGER__LISTEN: "0.0.0.0:50051"
      INFERADB__LEDGER__METRICS: "0.0.0.0:9090"
      INFERADB__LEDGER__DATA: "/var/lib/ledger"
      RUST_LOG: "info,inferadb_ledger=debug"
    tmpfs:
      - /var/lib/ledger:uid=65532,gid=65532
    # Note: Healthcheck removed because distroless image has no shell/utilities.
    # CI uses host-side port checking instead. For local development with
    # docker-compose, the test-runner will retry connections automatically.
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # Test runner for Engine integration tests with Ledger backend
  test-runner:
    build:
      context: ../../
      dockerfile: docker/ledger-integration-tests/Dockerfile
    container_name: inferadb-engine-ledger-test-runner
    networks:
      - engine-ledger-test-network
    depends_on:
      ledger:
        condition: service_healthy
    environment:
      # Point to Ledger server
      LEDGER_ENDPOINT: "http://ledger:50051"
      LEDGER_NAMESPACE_ID: "1"
      LEDGER_VAULT_ID: "1"
      # Rust test configuration
      RUST_BACKTRACE: "1"
      RUST_LOG: "debug"
      # Enable Ledger integration tests
      RUN_LEDGER_INTEGRATION_TESTS: "1"
    volumes:
      # Mount Engine source for development
      - ../../:/workspace:cached
      # Mount shared crates
      - ../../../../crates:/shared-crates:cached
      # Mount ledger crates (for SDK)
      - ../../../../ledger/crates:/ledger-crates:ro
      # Cache cargo artifacts
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/workspace/target
    working_dir: /workspace
    command: >
      cargo test
        --package inferadb-engine-api
        --test ledger_integration
        -- --test-threads=1

networks:
  engine-ledger-test-network:
    driver: bridge
    name: inferadb-engine-ledger-test-net

volumes:
  cargo-registry:
    name: inferadb-engine-ledger-cargo-registry
  cargo-git:
    name: inferadb-engine-ledger-cargo-git
  target-cache:
    name: inferadb-engine-ledger-target-cache
