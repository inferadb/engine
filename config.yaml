# InferaDB Server Configuration
#
# This file configures the InferaDB policy evaluation engine.
# Configuration can be set via:
#   1. This YAML file (config.yaml)
#   2. Environment variables (INFERA__SECTION__KEY=value)
#   3. Command-line arguments (--section.key value)
#
# Environment variables take precedence over file config.
# Use double underscores for nesting: INFERA__SERVER__PORT=8080

# =============================================================================
# Server Settings
# =============================================================================

server:
  # Host address to bind to
  # "127.0.0.1" - localhost only (development)
  # "0.0.0.0" - all interfaces (production)
  host: "127.0.0.1"

  # Port to listen on
  # Default: 8080
  # Environment: INFERA__SERVER__PORT
  port: 8080

  # Number of worker threads for async runtime
  # Default: Number of CPU cores
  # Recommendation: Set to CPU core count for CPU-bound workloads
  worker_threads: 4

# =============================================================================
# Storage Backend
# =============================================================================

store:
  # Storage backend type
  # Options:
  #   - "memory": In-memory storage (development/testing only)
  #   - "foundationdb": Distributed, ACID-compliant storage (production)
  backend: "memory"

  # FoundationDB connection string (required if backend is "foundationdb")
  # Format: "fdb:cluster_file=/path/to/fdb.cluster"
  # Example: connection_string: "fdb:cluster_file=/etc/foundationdb/fdb.cluster"
  # Environment: INFERA__STORE__CONNECTION_STRING
  # connection_string: "fdb:cluster_file=/etc/foundationdb/fdb.cluster"

# =============================================================================
# Cache Configuration
# =============================================================================

cache:
  # Enable caching for authorization results
  # Recommendation: Always enable in production for performance
  enabled: true

  # Maximum number of cache entries
  # Higher values = more memory, better hit rate
  # Recommendation:
  #   - Development: 10,000
  #   - Production (small): 100,000
  #   - Production (large): 1,000,000+
  max_capacity: 10000

  # Time-to-live for cache entries (seconds)
  # Shorter TTL = fresher data, more storage calls
  # Longer TTL = better performance, stale data risk
  # Recommendation: 300 seconds (5 minutes)
  ttl_seconds: 300

# =============================================================================
# Observability
# =============================================================================

observability:
  # Log level
  # Options: "trace", "debug", "info", "warn", "error"
  # Recommendation:
  #   - Development: "debug"
  #   - Production: "info"
  log_level: "info"

  # Enable Prometheus metrics endpoint (/metrics)
  # Recommendation: Always enable for production monitoring
  metrics_enabled: true

  # Enable OpenTelemetry distributed tracing
  # Requires OTEL collector to be configured
  tracing_enabled: true

  # Optional: OpenTelemetry exporter endpoint
  # Example: otel_endpoint: "http://localhost:4317"
  # otel_endpoint: "http://localhost:4317"

# =============================================================================
# Authentication Configuration
# =============================================================================

auth:
  # Enable authentication
  # If false, all requests are allowed (ONLY for local development)
  # WARNING: Never disable auth in production
  # enabled: false  # Uncomment to disable auth (NOT RECOMMENDED)

  # Management API URL for token validation
  # The server calls this API to:
  #   - Fetch Ed25519 public keys for signature verification
  #   - Validate vault ownership
  #   - Check organization status
  # Format: "http://host:port" or "https://host:port"
  # Do NOT include trailing slash or /v1 suffix
  # Environment: INFERA__AUTH__MANAGEMENT_API_URL
  management_api_url: "http://localhost:8081"

  # Management API request timeout (milliseconds)
  # Recommendation: 5000ms (5 seconds)
  # Increase if management API is slow or remote
  # Environment: INFERA__AUTH__MANAGEMENT_API_TIMEOUT_MS
  management_api_timeout_ms: 5000

  # Management data cache TTL (seconds)
  # How long to cache vault and organization metadata
  # Shorter TTL = faster propagation of deletions, more API calls
  # Longer TTL = better performance, slower propagation
  # Recommendation: 300 seconds (5 minutes)
  # Environment: INFERA__AUTH__MANAGEMENT_CACHE_TTL_SECONDS
  management_cache_ttl_seconds: 300

  # Certificate cache TTL (seconds)
  # How long to cache Ed25519 public keys
  # Shorter TTL = faster revocation, more API calls
  # Longer TTL = better performance, slower revocation
  # Recommendation: 900 seconds (15 minutes)
  # Environment: INFERA__AUTH__CERT_CACHE_TTL_SECONDS
  cert_cache_ttl_seconds: 900

  # Verify vault ownership
  # Ensures vault in JWT belongs to client's organization
  # Recommendation: Always true in production
  # Environment: INFERA__AUTH__MANAGEMENT_VERIFY_VAULT_OWNERSHIP
  management_verify_vault_ownership: true

  # Verify organization status
  # Checks if organization is active (not suspended)
  # Recommendation: Always true in production
  # Environment: INFERA__AUTH__MANAGEMENT_VERIFY_ORG_STATUS
  management_verify_org_status: true

  # Optional: Enable JWT replay protection (requires Redis)
  # Prevents reuse of JWT tokens by tracking jti claims
  # replay_protection: true
  # redis_url: "redis://localhost:6379"
  # redis_key_prefix: "infera:jti:"
  # redis_ttl_seconds: 300  # Should match max JWT lifetime

# =============================================================================
# Example Configurations for Different Environments
# =============================================================================

# ---------------------
# Development
# ---------------------
# server:
#   host: "127.0.0.1"
#   port: 8080
#   worker_threads: 2
# store:
#   backend: "memory"
# cache:
#   enabled: true
#   max_capacity: 1000
#   ttl_seconds: 60
# observability:
#   log_level: "debug"
#   metrics_enabled: true
#   tracing_enabled: false
# auth:
#   management_api_url: "http://localhost:8081"
#   management_api_timeout_ms: 5000
#   management_cache_ttl_seconds: 60
#   cert_cache_ttl_seconds: 60

# ---------------------
# Production (Small)
# ---------------------
# server:
#   host: "0.0.0.0"
#   port: 8080
#   worker_threads: 8
# store:
#   backend: "foundationdb"
#   connection_string: "fdb:cluster_file=/etc/foundationdb/fdb.cluster"
# cache:
#   enabled: true
#   max_capacity: 100000
#   ttl_seconds: 300
# observability:
#   log_level: "info"
#   metrics_enabled: true
#   tracing_enabled: true
#   otel_endpoint: "http://otel-collector:4317"
# auth:
#   management_api_url: "https://management.internal.example.com"
#   management_api_timeout_ms: 5000
#   management_cache_ttl_seconds: 300
#   cert_cache_ttl_seconds: 900
#   management_verify_vault_ownership: true
#   management_verify_org_status: true

# ---------------------
# Production (Large/High-Throughput)
# ---------------------
# server:
#   host: "0.0.0.0"
#   port: 8080
#   worker_threads: 16  # Match CPU cores
# store:
#   backend: "foundationdb"
#   connection_string: "fdb:cluster_file=/etc/foundationdb/fdb.cluster"
# cache:
#   enabled: true
#   max_capacity: 1000000  # 1M entries
#   ttl_seconds: 300
# observability:
#   log_level: "info"
#   metrics_enabled: true
#   tracing_enabled: true
#   otel_endpoint: "http://otel-collector:4317"
# auth:
#   management_api_url: "https://management.internal.example.com"
#   management_api_timeout_ms: 3000  # Tighter timeout
#   management_cache_ttl_seconds: 600  # Longer cache for performance
#   cert_cache_ttl_seconds: 1800  # 30 minutes
#   management_verify_vault_ownership: true
#   management_verify_org_status: true
#   replay_protection: true
#   redis_url: "redis://redis-cluster:6379"
#   redis_key_prefix: "infera:jti:"
#   redis_ttl_seconds: 300

# ---------------------
# CI/CD Testing
# ---------------------
# server:
#   host: "0.0.0.0"
#   port: 8080
#   worker_threads: 2
# store:
#   backend: "memory"
# cache:
#   enabled: false  # Disable for deterministic tests
# observability:
#   log_level: "warn"  # Reduce noise in CI logs
#   metrics_enabled: false
#   tracing_enabled: false
# auth:
#   management_api_url: "http://management:8081"
#   management_api_timeout_ms: 10000  # Higher for slow CI
#   management_cache_ttl_seconds: 30
#   cert_cache_ttl_seconds: 30

# =============================================================================
# Environment Variable Examples
# =============================================================================
#
# All configuration can be overridden via environment variables using the
# pattern: INFERA__SECTION__KEY=value
#
# export INFERA__SERVER__HOST="0.0.0.0"
# export INFERA__SERVER__PORT=8080
# export INFERA__SERVER__WORKER_THREADS=8
# export INFERA__STORE__BACKEND="foundationdb"
# export INFERA__STORE__CONNECTION_STRING="fdb:cluster_file=/etc/foundationdb/fdb.cluster"
# export INFERA__CACHE__ENABLED=true
# export INFERA__CACHE__MAX_CAPACITY=100000
# export INFERA__CACHE__TTL_SECONDS=300
# export INFERA__OBSERVABILITY__LOG_LEVEL="info"
# export INFERA__OBSERVABILITY__METRICS_ENABLED=true
# export INFERA__OBSERVABILITY__TRACING_ENABLED=true
# export INFERA__AUTH__MANAGEMENT_API_URL="https://management.example.com"
# export INFERA__AUTH__MANAGEMENT_API_TIMEOUT_MS=5000
# export INFERA__AUTH__MANAGEMENT_CACHE_TTL_SECONDS=300
# export INFERA__AUTH__CERT_CACHE_TTL_SECONDS=900
# export INFERA__AUTH__MANAGEMENT_VERIFY_VAULT_OWNERSHIP=true
# export INFERA__AUTH__MANAGEMENT_VERIFY_ORG_STATUS=true

# =============================================================================
# For more information:
# =============================================================================
# - Configuration Guide: docs/guides/configuration.md
# - Authentication Setup: docs/authentication.md
# - Deployment Guide: docs/guides/deployment.md
# - Performance Tuning: docs/operations/performance.md
