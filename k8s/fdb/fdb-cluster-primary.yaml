# FoundationDB Cluster - Primary Region
# ======================================
# This manifest defines a FoundationDB cluster for the primary region
# in a multi-region Fearless DR deployment.
#
# Prerequisites:
# - FDB Kubernetes Operator must be installed
# - Tailscale auth secret must exist (if using cross-region networking)
#
# Usage:
# 1. Update the region/datacenter IDs to match your deployment
# 2. Adjust process counts based on your scale requirements
# 3. Configure the multi-region settings to match your DR topology
#
# kubectl apply -f fdb-cluster-primary.yaml

apiVersion: apps.foundationdb.org/v1beta2
kind: FoundationDBCluster
metadata:
  name: inferadb-fdb
  namespace: inferadb
  labels:
    app.kubernetes.io/name: foundationdb
    app.kubernetes.io/instance: inferadb-fdb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: inferadb
    topology.kubernetes.io/region: us-west-1
    inferadb.io/is-primary: "true"
  annotations:
    inferadb.io/region: us-west-1
    inferadb.io/priority: "1"
spec:
  version: 7.3.43

  # Process counts - adjust based on your workload
  # Recommended minimums for production:
  # - storage: 3 (for redundancy)
  # - log: 3 (for transaction durability)
  # - stateless: 3 (for coordinators and other roles)
  processCounts:
    storage: 3
    log: 3
    stateless: 3
    clusterController: 1

  # Database configuration
  databaseConfiguration:
    # Redundancy mode for data durability
    # - double: 2 copies of data (tolerates 1 failure)
    # - triple: 3 copies of data (tolerates 2 failures)
    redundancy_mode: double

    # Storage engine
    # - ssd-2: Optimized for SSDs (recommended)
    # - ssd: Legacy SSD engine
    # - memory: In-memory storage (faster but limited by RAM)
    storage_engine: ssd-2

    # Multi-region configuration for Fearless DR
    # This defines the topology for cross-region replication
    usable_regions: 1 # Number of regions that must be available
    regions:
      - datacenters:
          - id: us-west-1
            priority: 1 # Primary region (highest priority)
          - id: us-west-1a
            priority: 1
            satellite: 0
      - datacenters:
          - id: eu-central-1
            priority: 2 # DR region (lower priority)
          - id: eu-central-1a
            priority: 2
            satellite: 0

  # Fault domain configuration
  # Ensures FDB understands the cluster topology
  faultDomain:
    key: foundationdb.org/fdb-zone-id
    value: us-west-1

  # Routing configuration for client connections
  routing:
    publicIPSource: pod # Use pod IP for client connections

  # Pod template for all FDB processes
  processes:
    general:
      podTemplate:
        spec:
          # Security context
          securityContext:
            fsGroup: 4059

          containers:
            # Main FDB container
            - name: foundationdb
              resources:
                requests:
                  cpu: "1"
                  memory: 4Gi
                limits:
                  cpu: "2"
                  memory: 8Gi
              securityContext:
                runAsUser: 4059
                runAsGroup: 4059

            # Tailscale sidecar for cross-region networking
            # Remove this container if not using Tailscale
            - name: tailscale
              image: tailscale/tailscale:v1.56.1
              imagePullPolicy: IfNotPresent
              env:
                - name: TS_AUTHKEY
                  valueFrom:
                    secretKeyRef:
                      name: tailscale-auth
                      key: authkey
                - name: TS_KUBE_SECRET
                  value: ""
                - name: TS_USERSPACE
                  value: "true"
                - name: TS_ACCEPT_DNS
                  value: "false"
                - name: TS_HOSTNAME
                  value: "fdb-us-west-1"
              args:
                - "--accept-routes"
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 200m
                  memory: 128Mi
              securityContext:
                runAsUser: 0
                capabilities:
                  add:
                    - NET_ADMIN

          # Spread FDB pods across nodes
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchLabels:
                        foundationdb.org/fdb-cluster-name: inferadb-fdb
                    topologyKey: kubernetes.io/hostname

          # Spread across availability zones
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: topology.kubernetes.io/zone
              whenUnsatisfiable: ScheduleAnyway
              labelSelector:
                matchLabels:
                  foundationdb.org/fdb-cluster-name: inferadb-fdb

      # Persistent volume configuration
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 128Gi
          # Uncomment and set your storage class
          # storageClassName: fast-ssd

  # Sidecar container settings
  sidecarContainer:
    enableLivenessProbe: true
    enableReadinessProbe: true

  # Automation configuration
  automationOptions:
    deletionMode: All
    removalMode: PodUpdateModeAll

---
# Service for external access (optional)
apiVersion: v1
kind: Service
metadata:
  name: inferadb-fdb
  namespace: inferadb
  labels:
    app.kubernetes.io/name: foundationdb
    app.kubernetes.io/instance: inferadb-fdb
spec:
  selector:
    foundationdb.org/fdb-cluster-name: inferadb-fdb
  ports:
    - name: fdb
      port: 4500
      targetPort: 4500
      protocol: TCP
  type: ClusterIP
