# FoundationDB Configuration Options
# ===================================
# This ConfigMap contains FDB configuration options and cluster file templates
# for multi-region deployments.
#
# Usage:
# - Mount this ConfigMap into Engine pods for FDB connection
# - The cluster file is auto-generated by the FDB operator
# - Use the configuration reference for tuning

apiVersion: v1
kind: ConfigMap
metadata:
  name: foundationdb-config
  namespace: inferadb
  labels:
    app.kubernetes.io/name: foundationdb
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: inferadb
data:
  # FDB Cluster File Template
  # The actual cluster file is generated by the FDB operator
  # This is a reference template showing the format
  fdb.cluster.template: |
    # FDB Cluster File Format:
    # <description>:<id>@<coordinators>
    #
    # Example for single-region:
    # inferadb:abc123@fdb-0.fdb.inferadb:4500,fdb-1.fdb.inferadb:4500,fdb-2.fdb.inferadb:4500
    #
    # Example for multi-region with Tailscale:
    # inferadb:abc123@fdb-us-west-1:4500,fdb-eu-central-1:4500

  # FDB Configuration Reference
  # These are the key configuration options for multi-region deployments
  configuration-reference.yaml: |
    # FoundationDB Multi-Region Configuration Reference
    # ==================================================

    # Redundancy Modes
    # ----------------
    # single       - 1 copy (development only)
    # double       - 2 copies, tolerates 1 failure
    # triple       - 3 copies, tolerates 2 failures
    # three_datacenter - 3 copies across 3 DCs
    # three_data_hall  - 3 copies across 3 data halls

    # Storage Engines
    # ---------------
    # ssd-2   - Optimized for SSDs (recommended)
    # ssd     - Legacy SSD engine
    # memory  - In-memory (fast but volatile)

    # Fearless DR Configuration
    # -------------------------
    # usable_regions: Number of regions that must be available
    #   - 1: Only primary needs to be available (DR is passive)
    #   - 2: Both regions must be available for writes
    #
    # satellite_logs: Number of transaction log replicas in satellite DCs
    #   - Higher = more durable but slower cross-region writes
    #   - Recommended: 4 for production

    # Region Priority
    # ---------------
    # Lower number = higher priority for leadership
    # Example:
    #   us-west-1: priority 1 (primary)
    #   eu-central-1: priority 2 (DR)
    #   ap-southeast-1: priority 3 (backup DR)

    # Coordinator Placement
    # ---------------------
    # For multi-region, coordinators should be placed:
    #   - 2 in primary region
    #   - 2 in secondary region
    #   - 1 in third region (tie-breaker) OR
    #   - Use odd total for quorum

  # Tuning Parameters
  tuning.conf: |
    # FDB Tuning Parameters for Production
    # ====================================

    # Memory Configuration
    # --------------------
    # Set based on your workload:
    # - Read-heavy: Increase cache size
    # - Write-heavy: Increase storage memory

    # storage_memory = 1GB        # Per storage process
    # storage_cache_memory = 4GB  # Shared cache

    # Network Configuration
    # ---------------------
    # For cross-region deployments:
    # - Increase timeouts for high-latency links
    # - Enable TLS for security

    # tls_certificate_file = /etc/fdb/tls/cert.pem
    # tls_key_file = /etc/fdb/tls/key.pem
    # tls_ca_file = /etc/fdb/tls/ca.pem

    # Monitoring
    # ----------
    # Enable trace logs for debugging
    # trace_format = json
    # trace_clock_source = now

  # Multi-Region Deployment Checklist
  checklist.md: |
    # Multi-Region Deployment Checklist

    ## Pre-Deployment
    - [ ] Verify Kubernetes clusters in all regions
    - [ ] Install FDB Kubernetes Operator in all regions
    - [ ] Create Tailscale auth keys
    - [ ] Configure Tailscale ACLs for FDB traffic (ports 4500, 4501)
    - [ ] Verify cross-region network connectivity

    ## Primary Region Deployment
    - [ ] Deploy FDB cluster in primary region
    - [ ] Wait for cluster to become healthy
    - [ ] Verify coordinator election
    - [ ] Test local read/write operations

    ## Secondary Region Deployment
    - [ ] Deploy FDB cluster in secondary region
    - [ ] Verify replication status via fdbcli
    - [ ] Check replication lag metrics
    - [ ] Test failover (optional, recommended)

    ## Application Deployment
    - [ ] Deploy InferaDB Engine in all regions
    - [ ] Verify Engine connects to FDB
    - [ ] Test cross-region service discovery
    - [ ] Verify authorization decisions work

    ## Monitoring
    - [ ] Configure Prometheus/Grafana dashboards
    - [ ] Set up alerts for:
      - [ ] Replication lag > 5 seconds
      - [ ] FDB cluster health
      - [ ] Cross-region connectivity

    ## Operational Readiness
    - [ ] Document failover procedure
    - [ ] Test failover and failback
    - [ ] Document recovery procedures
    - [ ] Train operations team

---
# ConfigMap for FDB cluster file (populated by operator)
apiVersion: v1
kind: ConfigMap
metadata:
  name: foundationdb-cluster-file
  namespace: inferadb
  labels:
    app.kubernetes.io/name: foundationdb
    app.kubernetes.io/component: cluster-file
    app.kubernetes.io/part-of: inferadb
data:
  # This will be populated by the FDB Kubernetes Operator
  # Do not modify manually
  fdb.cluster: ""
