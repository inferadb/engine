# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: Release

on:
  # Called by release-please when a release PR is merged
  workflow_call:
    inputs:
      tag_name:
        description: "Release tag (e.g., v1.0.0)"
        type: string
        required: true
      version:
        description: "Release version (e.g., 1.0.0)"
        type: string
        required: true
  # Manual trigger for hotfix releases
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true

# Permissions for SLSA provenance and releases
permissions:
  contents: write
  packages: write
  id-token: write
  actions: read

env:
  CARGO_TERM_COLOR: always
  REGISTRY: ghcr.io
  IMAGE_NAME: inferadb/engine

jobs:
  # Determine version from trigger source
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Determine version
        id: version
        env:
          CALL_VERSION: ${{ inputs.version }}
          CALL_TAG: ${{ inputs.tag_name }}
          DISPATCH_VERSION: ${{ github.event.inputs.version }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            # Manual trigger - version includes 'v' prefix
            VERSION="${DISPATCH_VERSION#v}"
            TAG_NAME="v${VERSION}"
          else
            # Called from release-please
            VERSION="$CALL_VERSION"
            TAG_NAME="$CALL_TAG"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "Release version: ${VERSION}, tag: ${TAG_NAME}"

  # Create GitHub release (only for workflow_dispatch; release-please creates its own)
  create-release:
    name: Create Release
    needs: prepare
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Create Release
        uses: step-security/action-gh-release@674f8f866246c6b91bd3f1688ba95e27b2ae8d2e # v2.4.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: Release ${{ needs.prepare.outputs.tag_name }}
          draft: false
          prerelease: false

  # Build and publish documentation
  docs:
    name: Build Documentation
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CARGO_INCREMENTAL: 0
      RUSTFLAGS: "-C codegen-units=16 -C link-arg=-fuse-ld=mold"
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable

      - name: Install mold linker
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Install development tools via Mise
        uses: step-security/mise-action@2fa1b2b4fa1577588d8ac75f4dfa0f67c266d2a0 # v3.4.1
        with:
          install_args: protobuf
          cache: true

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: docs-4-core

      - name: Build documentation
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Add index redirect
        run: |
          echo '<meta http-equiv="refresh" content="0; url=inferadb">' > target/doc/index.html

      - name: Upload documentation artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: documentation
          path: target/doc
          retention-days: 30

      - name: Compress documentation
        env:
          VERSION: ${{ needs.prepare.outputs.tag_name }}
        run: |
          cd target
          tar czf "docs-${VERSION}.tar.gz" doc/

      - name: Upload docs to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.tag_name }}
        run: |
          gh release upload "$VERSION" "target/docs-${VERSION}.tar.gz" --clobber

  # Build release binaries for multiple platforms
  build-binaries:
    name: Build Binaries (${{ matrix.target }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: inferadb
            asset_name: inferadb-linux-x86_64

          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: inferadb
            asset_name: inferadb-linux-aarch64

          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: inferadb
            asset_name: inferadb-macos-x86_64

          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: inferadb
            asset_name: inferadb-macos-aarch64

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install mold linker (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq mold

      - name: Install development tools via Mise
        uses: step-security/mise-action@2fa1b2b4fa1577588d8ac75f4dfa0f67c266d2a0 # v3.4.1
        with:
          install_args: protobuf
          cache: true

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get install -y -qq gcc-aarch64-linux-gnu

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Configure build environment
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "RUSTFLAGS=-C codegen-units=16 -C link-arg=-fuse-ld=mold" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "RUSTFLAGS=-C codegen-units=16" >> $GITHUB_ENV
            echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          fi

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2
        with:
          shared-key: release-${{ matrix.os }}-${{ matrix.target }}

      - name: Build release binary
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary
        run: |
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          else
            strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          fi

      - name: Generate SBOM
        run: |
          cargo install cargo-sbom
          cargo sbom --output-format spdx_json_2_3 > sbom-${{ matrix.target }}.spdx.json

      - name: Compress binary
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ${{ matrix.asset_name }}.tar.gz ${{ matrix.artifact_name }}

      - name: Upload binary to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.tag_name }}
        run: |
          gh release upload "$VERSION" \
            "target/${{ matrix.target }}/release/${{ matrix.asset_name }}.tar.gz" --clobber

      - name: Upload SBOM to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.tag_name }}
        run: |
          gh release upload "$VERSION" \
            "sbom-${{ matrix.target }}.spdx.json" --clobber

      - name: Compute hash for provenance
        id: hash
        run: |
          cd target/${{ matrix.target }}/release
          HASH=$(sha256sum ${{ matrix.asset_name }}.tar.gz | base64 -w0)
          echo "hash=${HASH}" >> "$GITHUB_OUTPUT"

    outputs:
      hash-linux-x86_64: ${{ steps.hash.outputs.hash }}

  # Aggregate hashes for SLSA provenance
  aggregate-hashes:
    name: Aggregate Hashes
    needs: [prepare, build-binaries]
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.aggregate.outputs.hashes }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: /tmp/artifacts

      - name: Aggregate hashes
        id: aggregate
        run: |
          # Compute hashes of all release tarballs
          cd /tmp/artifacts || exit 0
          # Find all tarballs and compute their hashes
          find . -name "*.tar.gz" -exec sha256sum {} \; | base64 -w0 > hashes.txt
          HASHES=$(cat hashes.txt)
          echo "hashes=${HASHES}" >> "$GITHUB_OUTPUT"

  # Generate SLSA provenance for binaries
  provenance:
    name: Generate SLSA Provenance
    needs: [prepare, build-binaries, aggregate-hashes]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: "${{ needs.aggregate-hashes.outputs.hashes }}"
      upload-assets: true
      upload-tag-name: ${{ needs.prepare.outputs.tag_name }}

  # Build and push Docker images to both Docker Hub and GitHub Container Registry
  build-docker:
    name: Build Docker (${{ matrix.platform }})
    needs: prepare
    environment: release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
            suffix: amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            suffix: arm64
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: step-security/setup-buildx-action@8c8aef2d414c0b66518fee2b7084e0986f82d7ac # v3.11.1

      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: step-security/docker-build-push-action@a8c3d08b23f8be6aeed43eb1a14ce6fe51284438 # v6.18.0
        with:
          context: .
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=release-${{ matrix.suffix }}
          cache-to: type=gha,mode=max,scope=release-${{ matrix.suffix }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: digests-release-${{ matrix.suffix }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  # Merge platform-specific images into multi-arch manifest and push to both registries
  merge-docker:
    name: Create Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [prepare, build-docker]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Download digests
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: /tmp/digests
          pattern: digests-release-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: step-security/setup-buildx-action@8c8aef2d414c0b66518fee2b7084e0986f82d7ac # v3.11.1

      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for GHCR
        id: meta-ghcr
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.prepare.outputs.tag_name }}
            type=raw,value=v${{ needs.prepare.outputs.version }}

      - name: Extract metadata for Docker Hub
        id: meta-hub
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: inferadb/inferadb
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.prepare.outputs.tag_name }}
            type=raw,value=v${{ needs.prepare.outputs.version }}

      - name: Create GHCR manifest list and push
        working-directory: /tmp/digests
        env:
          DOCKER_METADATA_OUTPUT_JSON: ${{ steps.meta-ghcr.outputs.json }}
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'ghcr.io/inferadb/engine@sha256:%s ' *)

      - name: Create Docker Hub manifest list and push
        working-directory: /tmp/digests
        env:
          VERSION: ${{ needs.prepare.outputs.tag_name }}
        run: |
          # Re-tag and push to Docker Hub
          docker buildx imagetools create \
            -t inferadb/inferadb:latest \
            -t "inferadb/inferadb:${VERSION}" \
            $(printf 'ghcr.io/inferadb/engine@sha256:%s ' *)

      - name: Inspect images
        run: |
          echo "=== GHCR Image ==="
          docker buildx imagetools inspect ghcr.io/inferadb/engine:latest
          echo "=== Docker Hub Image ==="
          docker buildx imagetools inspect inferadb/inferadb:latest

  # Generate SBOM for Docker image
  sbom-docker:
    name: Generate Docker SBOM
    runs-on: ubuntu-latest
    needs: [prepare, merge-docker]
    permissions:
      contents: write
      packages: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Login to GitHub Container Registry
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM
        uses: anchore/sbom-action@e11c554f704a0b820cbf8c51673f6945e0731532 # v0.20.0
        with:
          image: ghcr.io/inferadb/engine:latest
          artifact-name: docker-sbom.spdx.json
          output-file: docker-sbom.spdx.json

      - name: Upload SBOM to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.tag_name }}
        run: |
          gh release upload "$VERSION" docker-sbom.spdx.json --clobber
